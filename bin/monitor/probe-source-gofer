#!/usr/bin/env bash
set -u -e -o pipefail

declare -A _symbolMap
_symbolMap["BTCUSD"]="BTC/USD"
_symbolMap["ETHUSD"]="ETH/USD"

_getSymbol() {
	local _id="$1"
	if [[ ${_symbolMap["$_id"]+_exists} ]]; then
		echo "${_symbolMap["$_id"]}"
	else
		echo "$_id"
	fi
}

echo "Probing Gofer" >&2

cat | while read -r line
do
  symbol=$(_getSymbol "$(jq -r .symbol <<<"$line")")
  jq --null-input --compact-output \
    --arg symbol "$symbol" \
    --arg price "$(gofer --config "$GOFER_CONFIG" price "$symbol" 2>/dev/null | jq '.price')" \
    --argjson ts "$(date +%s)" \
    '{symbol:$symbol,price:$price,ts:$ts}'
done
