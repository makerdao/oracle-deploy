#!/usr/bin/env bash
set -u -e -o pipefail

export ETH_RPC_URL="$1"

echo "Probing Contracts (ethNode: $ETH_RPC_URL)" >&2

cat | while read -r line
do
  symbol="$(jq -r '.symbol' <<<"$line")"
  address=$(jq -r '.address' <<<"$line")
  rawStorage=$(seth storage "$address" 0x1)
  jq --null-input --compact-output \
    --arg symbol "$symbol" \
    --arg price "$(seth --from-wei "$(seth --to-dec "${rawStorage:34:32}")")" \
    --argjson ts "$(date +%s)" \
    '{symbol:$symbol,price:$price,ts:$ts}' | tee >(cat >&2)
done
